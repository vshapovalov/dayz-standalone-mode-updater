MANDATORY TASK LOGGING (do this before any other work):\n1) Ensure there is a directory named `tasks/` at repo root (create if missing).\n2) Determine the next task number by listing existing files `tasks/task_*.md`:\n   - If none exist, start with task number = 1.\n   - Otherwise, set task number = (max existing number + 1).\n3) Create a new markdown file: `tasks/task_{N}.md`.\n4) Save the FULL EXACT PROMPT TEXT (verbatim) into that file, including this mandatory logging block and everything below it.\n5) Only after the file is created, proceed with implementing the task.\n\n\n\nImplement orchestrator loops and phase ordering.\n\nThere are 3 periodic loops:\n1) Modlist poll loop (every modlist_poll_seconds):\n   - poll all servers in parallel (limit modlist_poll_parallelism)\n   - on success: parse+update state; set needs_mod_update=true if modset hash changed\n\n2) Workshop poll loop (every workshop_poll_seconds):\n   - compute candidate_mods union from state\n   - fetch time_updated via Steam Web API batching\n   - compute mods_to_update_locally\n   - if non-empty -> trigger SteamCMD update phase\n\n3) RCON tick loop (every rcon_tick_seconds):\n   - handle countdown/shutdown for servers with needs_shutdown=true\n\nPhase ordering constraints:\n- When Workshop poll triggers mods_to_update_locally:\n  - run SteamCMD sequentially (global mutex)\n  - after SteamCMD success per mod: mark all servers that use that mod needs_mod_update=true\n  - after SteamCMD batch ends: run SFTP sync phase for all servers with needs_mod_update=true\n    (parallel servers limit sftp_sync_parallelism_servers)\n\nSFTP sync phase:\n- For each server with needs_mod_update=true:\n  - stage="syncing"\n  - sync only mods where local_updated_at != synced_mods[id]\n  - on full success -> stage="countdown" and needs_shutdown=true\n  - on failure -> stage="error" and keep needs_mod_update=true\n\nPersistence:\n- State changes must be saved at least every state_flush_seconds and also on graceful shutdown.\n- Ensure no concurrent writers corrupt state.json (single writer / locked Update API).\n\nAdd end-to-end integration test (can be limited):\n- Mock Workshop API server\n- Mock SteamCMD runner (interface) that “downloads” into temp dirs\n- Real SFTP container for remote filesystem\n- Assert that mod update leads to sync and sets needs_shutdown with deadline.\n\nReturn code changes by file path.
